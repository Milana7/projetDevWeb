{% extends 'base.html.twig' %}

{% block title %}Liste des sorties{% endblock %}
{% block body %}
    <style>
        .example-wrapper {
            margin: 1em auto;
            max-width: 800px;
            width: 95%;
            font: 18px/1.5 sans-serif;
        }

        .example-wrapper code {
            background: #F5F5F5;
            padding: 2px 6px;
        }
    </style>

    <div class="example-wrapper">
        <h1>Liste des sorties </h1>

        <h5>Filtrer les sorties </h5>
        {{ form_start(filtre) }}

        {{ form_end(filtre) }}
        <br>
        <br>
        <br>
        <div id="tableSorties">
            <table border="1">
                <tr>
                    <td height="100px">Nom de la sortie</td>
                    <td>Date de la sortie</td>
                    <td>Clôture</td>
                    <td>Inscrits/Places</td>
                    <td>Etat</td>
                    <td>Inscrit</td>
                    <td>Organisateur</td>
                    <td>Actions</td>
                </tr>
                {% for sortie in listSortie %}
                    <tr>
                        <td>{{ sortie.nom }} </td>
                        <td>{{ sortie.dateHeureDebut | date('d/m/Y H:i') }} </td>
                        <td>{{ sortie.dateLimiteInscription | date('d/m/Y H:i') }} </td>
                        <td>{{ sortie.utilisateurs.count }} / {{ sortie.nbInscriptionsMax }}</td>
                        <td>{{ sortie.etat.libelle }}</td>
                        <td>{% for user in sortie.utilisateurs %}
                                {% if (user.id == app.user.id) %}
                                    X
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td> <a href="{{ path('utilisateur_detailProfil', {"id": sortie.organisateur.id}) }}">{{ sortie.organisateur.prenom }} {{ sortie.organisateur.nom|first }} </a></td>
                        <td>
                            <a href="{{ path('sorties_afficherSortie', {'sortieId': sortie.id}) }}"> Afficher</a>
                            {% set utilInscrit = false %}
                            {% for utilInscrits in sortie.utilisateurs %} {# utilisateurs inscrits #}
                                {% if (utilInscrits.id == app.user.id and sortie.etat.id != 3 and app.user.id != sortie.organisateur.id) %} {# si on est déjà inscrit à la sortie (donc on est pas l'organisateur) #}
                                    {% set utilInscrit =  true %}
                                    <a href="{{ path('sorties_desistement', {'sortieId': sortie.id}) }}"> Se
                                        désister</a>
                                {% endif %}
                            {% endfor %}

                            {# Pour s'inscrire : - je ne dois pas être l'organisateur
                                                 - etat = Ouvert
                                                 - date non dépassée
                                                 - il doit rester au moins une place
                                                 - je ne dois pas être déjà inscrit
                             #}
                            {% if (sortie.organisateur.id != app.user.id
                                and sortie.etat.id == 2
                                and sortie.utilisateurs.count < sortie.nbInscriptionsMax
                                and date(sortie.dateLimiteInscription) > date(dateJour)
                                and utilInscrit == false) %} {# on peut s'inscrire si on et pas l'utilisateur, s'il reste de la place et si la sortie n'est pas fermée ou expirée #}
                                    <a href="{{ path('sorties_inscription', {'sortieId': sortie.id}) }}">S'inscrire</a>
                            {% endif %}

                            {% if (sortie.organisateur.id == app.user.id and sortie.etat.id == 1) %} {# si on est l'organisateur de la sortie, on peut la modifier #}
                                <a href="{{ path('sortiesmodifier_sortie', {'sortieId': sortie.id}) }}">Modifier</a>
                            {% endif %}

                            {% if (sortie.organisateur.id == app.user.id and sortie.utilisateurs.count == 0) %} {# si on est l'organisateur de la sortie et s'il y a 0 inscrits on peut annuler #}
                                <a href="{{ path('sortiessortie_annulerSortie', {'id': sortie.id} ) }}">Annuler</a>
                            {% endif %}

                            {% if (sortie.organisateur.id == app.user.id and sortie.etat.id == 1) %} {# si on est l'organisateur de la sortie et s'il y a 0 inscrits on peut annuler #}
                                <a href="{{ path('sortiespublier', {'sortieId': sortie.id}) }}">Publier</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
{% endblock %}
